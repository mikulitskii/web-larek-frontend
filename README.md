# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
.
├── src/
│   ├── common.blocks/ [Стили компонент верстки]
│   ├── components/ [Реализация]
│   │   ├── base/ [Базовый код]
│   │   ├── model/ [Модели данных]
│   │   ├── presenter/ [Презентеры]
│   │   ├── services/ [Сервисы для работы с API]
│   │   ├── view/ [Отображения]
│   │   │   ├── common/ [Общие]
│   │   │   ├── forms/ [Формы]
│   │   │   ├── modal/ [Модальные окна]
│   │   │   ├── partial/ [Частичные]
│   │   │   ├── Main/
│   ├── pages/
│   │   ├── index.html [Основная страница и шаблоны компонент]
│   ├── types/ [Типизация]
│   │   ├── components/
│   │   │   ├── base/ [Базовый код]
│   │   │   ├── model/ [Модели данных]
│   │   │   ├── services/ [Сервисы для работы с API]
│   │   │   ├── view/ [Отображения]
│   ├── utils/
│   │   ├── constants.ts [Настройки проекта]
│   │   ├── utils.ts [Утилиты для работы с DOM]
├── index.ts [Точка входа приложения]

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Архитектура
В качестве основы для проекта используется паттерн MVP (Model-View-Presenter), который позволяет разделить данные, бизнес-логику и представление, обеспечивая лучшую архитектурную организацию и слабую связанность между компонентами. В данном приложении мы координируем работу всех View и Model через брокер сообщений.

### Базовые классы

##### Базовый Класс `API`

`API` — Базовая логика отправки запросов на сервер и обработку ответов.

**Конструктор**:
`constructor(baseUrl: string, options: RequestInit)` - Конструктор принимает базовый URL и общие настройки для запросов.

**Свойства**:
- `readonly baseUrl: string` - Основной URL для отправки запросов к API;
- `protected options: RequestInit` - Базовые настройки для запросов.

**Методы**:
- `protected handleResponse(response: Response): Promise<object>` - обрабатывает ответ от сервера
- `get(uri: string)` - Выполняет `GET` запросы по указанному URI и возвращает промис с ответом сервера;
- `post(uri: string, data: object, method: ApiPostMethods = 'POST')` - Выполняет `POST` запросы с данными на указанный URI и возвращает промис с ответом.

#### Базовый Класс `EventEmitter`

`EventEmitter` — Обеспечивает работу событий. Его функции: возможность установить и снять слушателей событий, вызвать слушателей при возникновении события

**Конструктор**: `constructor()`

**Параметры**:
- `_events: Map<EventName, Set<Subscriber>>` - Приватное свойство, содержащее набор подписчиков для каждого события.

**Методы**:
- `on<T extends object>(eventName: EventName, callback: (event: T) => void)` - Назначает обработчик для указанного события;
- `off(eventName: EventName, callback: Subscriber)` - Удаляет обработчик из события;
- `emit<T extends object>(eventName: string, data?: T)` - Генерирует событие с определённым именем и возможными данными;
- `onAll(callback: (event: EmitterEvent) => void)` - Позволяет регистрировать слушатель для всех событий;
- `offAll()` - Удаляет всех слушателей;
- `trigger<T extends object>(eventName: string, context?: Partial<T>)` - Вызывает колбек и генерирует событие по запросу.

#### Базовый Класс `Model`

`Model` - Абстрактный класс, предназначенный для работы с данными и бизнес логикой.

**Конструктор**:
`constructor(emitter: EventEmitter)` - Принимает Emitter для уведомлений представления об изменениях модели.

**Свойства**:
- `emitter: EventEmitter` - Экземпляр EventEmitter, обеспечивающий подписку и обработку событий изменения состояния.;

#### Базовый Класс `Presenter`

`Presenter` - Абстрактный класс, предназначен для связи между Model и View.

**Конструктор**:
`constructor(View: IViewConstructor<V, S>, model: M, emitter: E)` - Принимает конструктор для view, модель данных и emitter.

**Свойства**:
- `view: IView<V>` - Экземпляр отображения;
- `model: M` - Экземпляр модели данных;

**Методы**:
- `bindView()` - Для передачи коллбеков во View.
- `bindModel(emitter: E)` - Для подписки на события модели.

#### Базовый Класс `View`

`View` - Абстрактный класс, предоставляющий большинство методов для работы с отображением.

**Конструктор**:
`constructor(public element: HTMLElement, protected readonly settings: S)` - Принимает DOM-элемент и объект настроек.

**Свойства**:
- `element: HTMLElement` - Основной элемент представления;
- `settings: S` - Объект настроек отображения;
- `cache: Record<string, HTMLElement>` - Кэш DOM-элементов, чтобы избежать повторных запросов;
- `constructor` - Ссылка на собственный класс для реализации копирующего конструктора;

**Методы**:
- `init()` - Метод жизненного цикла, вызывается при инициализации; переопределяется в потомках.
- `copy(settings?: S): this` - Создаёт копию представления с новым DOM-элементом и объединёнными настройками.
- `render(data: Partial<T>): HTMLElement` - Обновляет отображение, применяя данные к текущему состоянию.
- `ensure<T>(query?: SelectorElement<T>, root?: HTMLElement): T` - Возвращает DOM-элемент по селектору, с кэшированием.
- `setElement<T>(query: SelectorElement<T>, value: HTMLElement)` - Заменяет DOM-элемент по селектору новым элементом.
- `ensureTemplate(query: string): HTMLElement` - Клонирует и удаляет шаблонный элемент из DOM.
- `create<T>(...)` - Универсальный метод создания DOM-элементов с пропсами и вложенными дочерними элементами.
- `setVisibility<T>(query: SelectorElement<T>, isVisible: boolean)` - Управляет видимостью элемента.
- `setValue<T>(query: SelectorElement<T>, value: ElementValue<T>)` - Универсально обновляет содержимое, свойства или детей DOM-элемента.

### Слой данных - Model

#### Класс AppState
Класс является основной моделью и отвечает за состояние данных приложения и возможные действия над ними. Класс имплементируют интерфейс AppState и наследуется от Model.

**Конструктор**:
`constructor(protected api: IStoreAPI, emitter: EventEmitter)` - Принимает API приложения и EventEmitter.

**Свойства**:
- `products: Map<string, Product>` - Карта всех товаров.
- `selectedProduct: Product | null` - Товар выбранный для просмотра в модальном окне.
- `basket: Map<string, Product>` - Карта товаров в корзине и их общая стоимость.
- `basketTotal: number` - Общая стоимость товаров в корзине.
- `basketCount: number` - Общее количество товаров в корзине.
- `contacts: Contacts` - Контактные данные формы заказа.
- `delivery: Delivery` - Данные для доставки и оплаты формы заказа.
- `order: Order` - Информация о заказе.
- `modal: ModalState` - Информация о модальном окне.

**Методы**:
- `loadProducts(): Promise<void>` - Загрузка товаров с сервера
- `createOrder(): Promise<OrderResult>` - Создание заказа
  // Пользовательские действия
- `selectProduct(id: string): void` - Выбор товара для превью
- `addToBasket(id: string): void` - Добавление товара в корзине
- `removeFromBasket(id: string): void` - Удаление товара из корзины
- `toggleBasketItem(id: string): void` - Добавление/удаление товара из корзины
- `fillContacts(contacts: Partial<Contacts>): void` - Заполнение контактных данных
- `fillDelivery(contacts: Partial<Delivery>): void` - Заполнение данных для доставки и метода оплаты
- `isValidContacts(): boolean` - Проверка на корректность контактных данных
- `isValidDelivery(): boolean` - Проверка на корректность данных для доставки и оплаты
  // Методы для работы с модальными окнами
- `openModal(modal: AppStateModals): void` - Уведомление об открытие модального окна, которое обрабатывается Presenter
- `setMessage(message: string | null, isError: boolean): void` - Изменение текста ошибки на модальном окне

### Слой представления - View

#### Класс `MainView`

`MainView` — Отвечает за инициализацию и управление всеми основными компонентами пользовательского интерфейса приложения. Наследуется от базового класса View.

**Конструктор**:
`constructor(element: HTMLElement, settings: MainSettings)` - Принимает корневой DOM-элемент и объект с настройками отображения.

**Свойства**:
- `gallery: ListView<CardCatalogData>` - Список карточек товаров в каталоге.
- `page: PageView` - Представление страницы, включая глобальные элементы.
- `basket: ModalView<BasketData>` - Модальное окно корзины.
- `preview: ModalView<CardPreviewData>` - Модальное окно предпросмотра карточки.
- `order: ModalView<DeliveryFormData>` - Модальное окно оформления заказа (форма доставки).
- `contacts: ModalView<ContactsFormData>` - Модальное окно ввода контактных данных.
- `success: ModalView<SuccessData>` - Модальное окно успешного оформления заказа.

**Методы**:
- `init()` - Метод жизненного цикла. Инициализирует все представления и модальные окна, настраивает шаблоны и коллбеки, сохраняет корневой element из PageView.
- `set counter(value: number)` - Устанавливает количество товаров в корзине (синхронизирует с PageView).
- `set items(value: CardCatalogData[])` - Передаёт список товаров в каталог.
- `set selected(value: CardCatalogData)` - Выделяет активную карточку в списке.
- `set isLocked(value: boolean)` - Управляет возможностью прокрутки при показе модального окна.

#### Класс `PageView`

`PageView` — Отвечающий за управление основными элементами страницы, такими как счетчик корзины и блокировка прокрутки при открытых модальных окнах. Наследуется от базового класса View.

**Конструктор**:
`constructor(element: HTMLElement, settings: PageSettings)` - Принимает корневой DOM-элемент и объект с настройками отображения.

**Методы**:
- `init()` - Метод жизненного цикла. Навешивает обработчик клика на кнопку корзины.
- `onClickHandler(event: MouseEvent)` - Обрабатывает клик по кнопке открытия корзины и вызывает переданный callback onClick.
- `set counter(value: number)` - Устанавливает числовое значение счетчика товаров в корзине.
- `set isLocked(value: boolean)` - Выделяет активную карточку в списке;Добавляет или удаляет CSS-класс блокировки прокрутки на элементе-обертке страницы в зависимости от значения.

#### Класс `ListView`

`ListView` — Предназначен для визуализации списка элементов. Наследуется от базового класса View.

**Конструктор**:
`constructor(element: HTMLElement, settings: ListSettings<T>)` - Принимает DOM-элемент и настройки списка, включая шаблон элемента списка.

**Свойства**:
- `_elements: Record<string, HTMLElement>` - Внутреннее хранилище DOM-элементов списка, индексированных по идентификатору.

**Методы**:
- `setActiveElement(element: HTMLElement)` - Делает переданный элемент активным, сбрасывая активность у остальных.
- `setActiveItem(id: string)` - Активирует элемент по его идентификатору, используя метод setActiveElement.
- `set items(items: T[])` - Обновляет список отображаемых элементов. Каждый элемент копируется из шаблона, заполняется данными и сохраняется во внутренний объект _elements.

#### Класс `CardView`

`CardView` — Универсальный класс для отображения карточки товара. Наследуется от базового класса View.

**Конструктор**:
`constructor(element: HTMLElement, settings: S)` - Принимает DOM-элемент карточки и частичные настройки типа CardSettings.

**Свойства**:
- `id: string` - Идентификатор карточки.

**Методы**:
- `set image(value: string)` - Устанавливает изображение карточки, задавая src у соответствующего элемента.
- `set title(value: string)` - Устанавливает заголовок карточки.
- `set category(value: string)` - Устанавливает категорию карточки и соответствующий CSS-класс из categoryClasses.
- `set price(value: string)` - Отображает цену, добавляя к числовому значению постфикс "синапсов". Если значение отсутствует — выводит "Бесценно".

#### Класс `CardBasketView`

`CardBasketView` — Компонент для отображения компактной карточки товара внутри корзины. Наследуется от CardView.

**Конструктор**:
`constructor(element: HTMLElement, settings: CardBasketSettings)` - Принимает DOM-элемент карточки и настройки для корзины.

**Методы**:
- `init()` - Устанавливает обработчик на элемент действия (action), переданный в настройках.
- `onClickHandler(event: MouseEvent)` - Вызывает переданный колбэк onClick, передавая событие и id карточки.
- `set index(value: string)` - Устанавливает порядковый номер товара в списке.

#### Класс `CardCatalogView`

`CardCatalogView` — Компонент для отображения карточки товара в каталоге. Наследуется от CardView.

**Конструктор**:
`constructor(element: HTMLElement, settings: CardCatalogSettings)` - Принимает DOM-элемент карточки и настройки для каталога.

**Методы**:
- `init()` - Устанавливает обработчик клика по всей карточке.
- `onClickHandler(event: MouseEvent)` - Вызывает колбэк onClick, передавая событие и id карточки.
- `set title(value: string)` - Устанавливает заголовок карточки и обновляет alt-текст изображения. Использует базовый сеттер и дополняет его логикой установки атрибута alt.

#### Класс `CardPreviewView`

`CardPreviewView` — компонент для отображения карточки товара в модальном окне предварительного просмотра. Наследуется от CardView.

**Конструктор**:
`constructor(element: HTMLElement, settings: CardPreviewSettings)` - Принимает DOM-элемент карточки и настройки превью.

**Методы**:
- `init()` - Устанавливает обработчик клика по кнопке действия.
- `onClickHandler(event: MouseEvent)` - Вызывает колбэк onClick, передавая событие и id карточки.
- `set title(value: string)` - Устанавливает заголовок карточки и обновляет alt-текст изображения.
- `set description(value: string)` - Устанавливает описание товара.
- `set price(value: string)` - Устанавливает цену и активирует/деактивирует кнопку действия в зависимости от наличия цены.
- `set isInBasket(value: string)` - Меняет текст кнопки действия в зависимости от состояния товара в корзине.

#### Класс `ModalView`

`ModalView` — Компонент для отображения и управления модальным окном. Наследуется от View.

**Конструктор**:
`constructor(element: HTMLElement, settings: ModalSettings<C>)` - Принимает DOM-элемент модального окна и настройки модального окна.

**Методы**:
- `init()` - Инициализирует обработчики событий для закрытия окна (клик по кнопке закрытия и по оверлею).
- `onCloseHandler(event?: MouseEvent)` - Закрывает модальное окно при клике по иконке закрытия или оверлею.
- `onOpenHandler()` - Открывает модальное окно, добавляя класс активности.
- `set content(data: C)` - Устанавливает содержимое модального окна, передавая данные в отображаемый контент.
- `set message(value: string | undefined)` - Устанавливает текст сообщения в модальном окне. Если значение не указано, скрывает сообщение.
- `set isActive(state: boolean)` - Открывает или закрывает модальное окно в зависимости от состояния (добавляет или удаляет класс активности).

#### Класс `BasketView`

`BasketView` — Компонент, отображающий экран корзины. Наследуется от View.

**Конструктор**:
`constructor(element: HTMLElement, settings: BasketSettings)` - Принимает DOM-элемент корзины и настройки.

**Методы**:
- `init()` - Инициализирует обработчики событий для кнопки "Следующий" и создает список товаров в корзине с использованием ListView.
- `set items(value: CardBasketData[])` - Устанавливает список товаров в корзину, передавая данные в ListView.
- `set total(value: string)` - Устанавливает итоговую сумму в корзине.
- `set isDisabled(state: boolean)` - Устанавливает состояние активности кнопки "Следующий" (включает или отключает кнопку).

#### Класс `DeliveryFormView`

`DeliveryFormView` — Компонент для отображения формы доставки. Наследуется от View.

**Конструктор**:
`constructor(element: HTMLElement, settings: DeliveryFormSettings)` - Принимает DOM-элемент и настройки для отображения формы доставки.

**Методы**:
- `init()` - Инициализирует элементы формы. Добавляет обработчики событий на кнопки выбора способа оплаты, форму отправки и поле ввода для адреса.
- `onSubmitHandler(event: SubmitEvent)` - Обработчик отправки формы, предотвращает стандартное поведение и вызывает метод onSubmit из настроек.
- `onClickHandler(event: MouseEvent)` - Обработчик клика по кнопкам оплаты, передает выбранный метод оплаты в обработчике onClick.
- `onChangeHandler(event: Event)` - Обработчик изменения адреса, передает новое значение в обработчик onChange.
- `set payment(value: PaymentMethod)` - Устанавливает активный метод оплаты, добавляя или убирая соответствующий класс.
- `set address(value: string)` - Устанавливает значение поля для адреса.
- `set isDisabled(value: string)` - Устанавливает свойство disabled для кнопки действия.

#### Класс `ContactsFormView`

`ContactsFormView` — Компонент для отображения формы ввода контактных данных (например, email и телефон). Наследуется от View.

**Конструктор**:
`constructor(element: HTMLElement, settings: ContactsFormSettings)` - Принимает DOM-элемент и настройки для отображения формы контактных данных.

**Методы**:
- `init()` - Инициализирует элементы формы. Добавляет обработчики событий на отправку формы и изменения в полях ввода email и телефона.
- `onSubmitHandler(event: SubmitEvent)` - Обработчик отправки формы, предотвращает стандартное поведение и вызывает метод onSubmit из настроек.
- `onClickHandler(event: MouseEvent)` - Обработчик изменений в полях ввода (email, телефон), передает измененные значения в обработчике onChange.
- `set email(value: string)` - Устанавливает значение поля для email.
- `set phone(value: string)` - Устанавливает значение поля для телефона.
- `set isDisabled(value: string)` - Устанавливает свойство disabled для кнопки действия.

#### Класс `SuccessView`

`SuccessView` — Компонент, отображающий экран подтверждения успешного заказа. Наследуется от View.

**Конструктор**:
`constructor(element: HTMLElement, settings: SuccessSettings)` - Принимает DOM-элемент и настройки для отображения экрана успешного заказа.

**Методы**:
- `init()` - Инициализирует обработчик клика для кнопки закрытия, который вызывает метод onCloseHandler.
- `onCloseHandler(event: MouseEvent)` - Закрывает модальное окно успешного заказа, удаляя активный класс у контейнера.
- `set total(value: string)` - Устанавливает итоговую сумму в сообщении о списании синапсов.

### Слой комуникации с сервером - API

#### Класс `StoreAPI`

`StoreAPI` — Специальный компонент для взаимодействия с API магазина (получение списка товаров, оформление заказа). Наследуется от базового класса API.

**Конструктор**:
`constructor(baseUrl, options)` - Принимает URL для API и параметры запроса.

**Свойства**:
- `cdn: string` - Базовый URL CDN сервера для загрузки изображений;

**Методы**:
- `getProducts(): Promise<Product[]>` - Получает список товаров с сервера;
- `createOrder(order: Order): Promise<OrderResult>` - Отправляет информацию о заказе на сервер и получает результат.

## Описание событий
Список всех отслеживаемых событий в системе:

- `modal:preview` - Открытие модального окна Preview
- `modal:basket` - Открытие модального окна Корзины
- `modal:delivery` - Открытие модального окна заказа (Доставка)
- `modal:contacts` - Открытие модального окна заказа (Контактные данные)
- `modal:success` - Открытие модального окна завершения заказа
- `modal:none` - Закрытие модального окна
- `change:products` - Изменение списка товаров
- `change:selectedProduct` - Изменение выбранного товара для Preview
- `change:order` - Изменение заказа
- `change:modal` - Изменение модального окна
- `change:modalMessage` - Изменение сообщения в модальном окне